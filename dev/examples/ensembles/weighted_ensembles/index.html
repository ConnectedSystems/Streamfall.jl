<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Weighted Ensemble Modeling · Streamfall Documentation</title><script data-outdated-warner src="../../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../assets/documenter.js"></script><script src="../../../siteinfo.js"></script><script src="../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../../"><img src="../../../assets/logo.svg" alt="Streamfall Documentation logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../../">Streamfall Documentation</a></span></div><form class="docs-search" action="../../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../../">Streamfall.jl Documentation</a></li><li><a class="tocitem" href="../../../primer/">Primer</a></li><li><a class="tocitem" href="../../../expected_data_formats/">Input data format</a></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../../examples/">Examples</a></li><li><a class="tocitem" href="../../node_creation/">Node creation</a></li><li><a class="tocitem" href="../../network_loading/">Network Loading</a></li><li><input class="collapse-toggle" id="menuitem-4-4" type="checkbox"/><label class="tocitem" for="menuitem-4-4"><span class="docs-label">Model evaluation</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../evaluation/simple_showcase/">A simple example</a></li><li><a class="tocitem" href="../../evaluation/model_comparison/">Model comparison example</a></li><li><a class="tocitem" href="../../evaluation/simple_multisystem/">Simple two-system interaction</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-5" type="checkbox"/><label class="tocitem" for="menuitem-4-5"><span class="docs-label">Calibration</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../calibration/calibration/">Example calibration</a></li><li><a class="tocitem" href="../../calibration/custom_calibration/">Customized calibration</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-6" type="checkbox" checked/><label class="tocitem" for="menuitem-4-6"><span class="docs-label">Ensemble modeling</span><i class="docs-chevron"></i></label><ul class="collapsed"><li class="is-active"><a class="tocitem" href>Weighted Ensemble Modeling</a></li></ul></li></ul></li><li><span class="tocitem">API</span><ul><li><a class="tocitem" href="../../../metrics/">Included metrics</a></li><li><input class="collapse-toggle" id="menuitem-5-2" type="checkbox"/><label class="tocitem" for="menuitem-5-2"><span class="docs-label">Nodes</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../API/nodes/Node/">Generic node methods</a></li><li><a class="tocitem" href="../../../API/nodes/IHACRES/">IHACRES</a></li><li><a class="tocitem" href="../../../API/nodes/HyMod/">HyMod</a></li><li><a class="tocitem" href="../../../API/nodes/GR4J/">GR4J</a></li><li><a class="tocitem" href="../../../API/nodes/SIMHYD/">SIMHYD</a></li><li><a class="tocitem" href="../../../API/nodes/Dam/">Dam (Storage Level)</a></li></ul></li><li><a class="tocitem" href="../../../API/plotting/">Plotting</a></li><li><a class="tocitem" href="../../../API/network/">Network</a></li><li><a class="tocitem" href="../../../API/climate/">Climate</a></li><li><a class="tocitem" href="../../../API/use_methods/">Methods to run a network or node</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li><a class="is-disabled">Ensemble modeling</a></li><li class="is-active"><a href>Weighted Ensemble Modeling</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Weighted Ensemble Modeling</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/ConnectedSystems/Streamfall.jl/blob/main/docs/src/examples/ensembles/weighted_ensembles.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Weighted-Ensemble-Modeling"><a class="docs-heading-anchor" href="#Weighted-Ensemble-Modeling">Weighted Ensemble Modeling</a><a id="Weighted-Ensemble-Modeling-1"></a><a class="docs-heading-anchor-permalink" href="#Weighted-Ensemble-Modeling" title="Permalink"></a></h1><p>Streamfall supports ensemble modeling using individual instances of rainfall-runoff models as the ensemble constituents. The default ensemble is a normalized weighted sum.</p><p>The usual setup process is shown here, detailed in previous sections of this guide.</p><pre><code class="language-julia hljs">using Statistics
using CSV, DataFrames
using StatsPlots
using Streamfall

data_dir = joinpath(
    dirname(dirname(pathof(Streamfall))),
    &quot;test/data&quot;
)

# Historic flows and dam level data
obs_data = CSV.read(
    joinpath(data_dir, &quot;cotter/climate/CAMELS-AUS_410730.csv&quot;),
    DataFrame;
    comment=&quot;#&quot;
)

Qo = extract_flow(obs_data, &quot;410730&quot;)
climate = extract_climate(obs_data)</code></pre><p>Specific node representations can then be created, each representing the same sub-catchment. A stream network is not considered for this demonstration.</p><pre><code class="language-julia hljs"># Create one instance each of IHACRES_CMD and GR4J
ihacres_node = create_node(IHACRESBilinearNode, &quot;410730&quot;, 129.2)
gr4j_node = create_node(GR4JNode, &quot;410730&quot;, 129.2)

# Create a weighted ensemble with equal weights
# The default behavior is to combine component predictions with a normalized weighted sum.
ensemble = create_node(WeightedEnsembleNode, [ihacres_node, gr4j_node], [0.5, 0.5])</code></pre><p>In previous examples, the <code>calibrate!()</code> method was used to calibrate nodes to available data. For WeightedEnsembleNodes, <code>calibrate!()</code> optimizes just the weights to allow for pre-calibrated instances to be provided for use in an ensemble. This may be useful if it is desired for the component models to be calibrated according to different criteria and objective functions.</p><p>A separate <code>calibrate_instances!()</code> method is available to calibrate individual component models (and the weights used).</p><pre><code class="language-julia hljs"># The default behaviour for WeightedEnsembleNodes are to calibrate just the weights.
# res, opt = calibrate!(ensemble, climate, Qo, (obs, sim) -&gt; 1.0 .- Streamfall.NmKGE(obs, sim); MaxTime=180)

# Here, the component models are uncalibrated so we calibrate these and the weights.
res, opt = calibrate_instances!(ensemble, climate, Qo, (obs, sim) -&gt; 1.0 .- Streamfall.NmKGE(obs, sim); MaxTime=180)</code></pre><p>Running the calibrated models directly, the amount of improvement to model performance can be assessed. Here, a 1-year burn in period is used.</p><pre><code class="language-julia hljs">run_node!(ihacres_node, climate)
run_node!(gr4j_node, climate)
run_node!(ensemble, climate)

burn_in = 365
burn_dates = timesteps(climate)[burn_in:end]
burn_obs = Qo[burn_in:end, &quot;410730&quot;]

ihacres_qp = quickplot(burn_obs, ihacres_node.outflow[burn_in:end], climate; label=&quot;IHACRES&quot;, log=true)
gr4j_qp = quickplot(burn_obs, gr4j_node.outflow[burn_in:end], climate; label=&quot;GR4J&quot;, log=true)
ensemble_qp = quickplot(burn_obs, ensemble.outflow[burn_in:end], climate; label=&quot;Weighted Ensemble&quot;, log=true)

plot(ihacres_qp, gr4j_qp, ensemble_qp; layout=(3, 1), size=(800, 1200))</code></pre><p>Below a small improvement to model performance based on the modified Kling-Gupta Efficiency score can be seen. Comparing the Q-Q plots, IHACRES had a tendency to underestimate low flows and high flows, whereas GR4J had a tendency to overestimate low flows.</p><p>The weighted ensemble combined characteristics of both, with a tendency to overestimate low flows as with GR4J.</p><p><img src="../../../assets/ensemble_model_comparison_quickplots.png" alt/></p><p>Comparing the temporal cross section to get an idea of seasonality:</p><pre><code class="language-julia hljs">ihacres_xs = temporal_cross_section(burn_dates, burn_obs, ihacres_node.outflow[burn_in:end]; title=&quot;IHACRES&quot;, yscale=:log10)
gr4j_xs = temporal_cross_section(burn_dates, burn_obs, gr4j_node.outflow[burn_in:end]; title=&quot;GR4J&quot;, yscale=:log10)
ensemble_xs = temporal_cross_section(burn_dates, burn_obs, ensemble.outflow[burn_in:end]; title=&quot;Weighted Ensemble (IHACRES-GR4J)&quot;, yscale=:log10)

plot(ihacres_xs, gr4j_xs, ensemble_xs; layout=(3, 1), size=(800, 1200))</code></pre><p>A reduction in the median error can be seen with extreme errors reduced somewhat.</p><p><img src="../../../assets/ensemble_xsection.png" alt/></p><p>The median error can then be applied to modelled streamflow (on a month-day basis) as a form of bias correction. Here, the correction factor is capped to -80% and +40% of predicted outflows.</p><pre><code class="language-julia hljs">q_star = Streamfall.apply_temporal_correction(ensemble, climate, Qo[:, &quot;410730&quot;]; low_cap=0.8, high_cap=0.4)

bc_ensemble_qp = quickplot(burn_obs, q_star[burn_in:end], climate; label=&quot;Bias Corrected Ensemble&quot;, log=true)

bias_corrected_xs = temporal_cross_section(
    burn_dates,
    burn_obs,
    q_star[burn_in:end];
    title=&quot;Bias Corrected Ensemble&quot;,
    yscale=:log10
)

ens_qp = plot(bc_ensemble_qp, bias_corrected_xs; layout=(2,1), size=(800, 800))</code></pre><p>It can be seen here that low flows are better represented, with a commensurate decrease in median error (and its variance). At the same time, performance at the 75 and 95% CI  remain steady relative to the original weighted ensemble results.</p><p><img src="../../../assets/ensemble_bias_corrected.png" alt/></p><p>This ensemble approach may be improved further by:</p><ul><li>Using a rolling window to smooth ensemble predictions</li><li>Defining a custom objective function to target specific conditions</li><li>Using more advanced ensemble approaches other than the simple weighted mean approach</li></ul></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../calibration/custom_calibration/">« Customized calibration</a><a class="docs-footer-nextpage" href="../../../metrics/">Included metrics »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.25 on <span class="colophon-date" title="Sunday 27 April 2025 03:38">Sunday 27 April 2025</span>. Using Julia version 1.11.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
